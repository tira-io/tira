syntax = "proto3";
// -----------------------------------------------------------------------------
// Compilation
// -----------------------------------------------------------------------------

// Install the Google Protobuf protoc compiler:
//   Web: http://code.google.com/p/protobuf/
//   Apt: Search your repository for 'protobuf-compiler'
//
// Compile the schema file to generate source code:
//   C++ : $ protoc --cpp_out=path/to/generated/code  tira_host.proto
//   Java: $ protoc --java_out=path/to/generated/code tira_host.proto
//   Java gRPC: $ protoc --plugin=protoc-gen-grpc-java=build/exe/java_plugin/protoc-gen-grpc-java --grpc-java_out=. --proto_path=. tira_host.proto
//     See https://github.com/grpc/grpc-java/tree/master/compiler
//
// Python:
//   Install gRPC for Python: https://grpc.io/docs/languages/python/quickstart/
//   $ python -m grpc_tools.protoc -I=. --python_out=. --grpc_python_out=. ./tira_host.proto

// -----------------------------------------------------------------------------
// Options
// -----------------------------------------------------------------------------

package tira.generated;

import "google/protobuf/empty.proto";
// import "tira_messages.proto";

// Becomes the package name of the generated Java code
option java_package = "de.webis.tira.client.web.generated";

// option java_multiple_files = true;
option java_outer_classname = "TiraHostMessages";
// option objc_class_prefix = "THM";

// Other options
option optimize_for = SPEED;

// -----------------------------------------------------------------------------
// Definitions
// -----------------------------------------------------------------------------

// The service definition.
service TiraHostService {
  rpc vm_backup (VmId) returns (Transaction) {}
  rpc vm_create (VmCreate) returns (Transaction) {}
  rpc vm_delete (VmId) returns (Transaction) {}
  rpc vm_info (VmId) returns (VmInfo) {}
  rpc vm_list (google.protobuf.Empty) returns (Transaction) {}
  rpc vm_metrics (VmId) returns (Transaction) {}
  rpc vm_sandbox (VmId) returns (Transaction) {}
  rpc vm_shutdown (VmId) returns (Transaction) {}
  rpc vm_snapshot (VmId) returns (Transaction) {}
  rpc vm_start (VmId) returns (Transaction) {}
  rpc vm_stop (VmId) returns (Transaction) {}
  rpc vm_unsandbox (VmId) returns (Transaction) {}
  rpc run_execute(RunDetails) returns (Transaction) {}
  rpc run_abort(VmId) returns (Transaction) {}
  rpc run_eval(RunDetails) returns (Transaction) {}
  rpc alive (google.protobuf.Empty) returns (google.protobuf.Empty) {}
}

service TiraApplicationService {
  rpc set_state (VmState) returns (Transaction) {}
  rpc confirm_vm_create (VmDetails) returns (Transaction) {}
  rpc confirm_vm_delete (VmId) returns (Transaction) {}
  rpc confirm_run_eval (EvaluationResults) returns (Transaction) {}
  // rpc confirm_run_execute (VmState) returns (Transaction) {} // TODO transmit the results of the run that should be displayed on the website (i.e. runDir without output)
  rpc confirm_transaction (Transaction) returns (Transaction) {}
}

enum Status {
  SUCCESS = 0;
  FAILED = 1;
}

enum State {
    UNDEFINED = 0;
    RUNNING = 1;
    POWERED_OFF = 2;
    POWERING_ON = 3;
    POWERING_OFF = 4;
    SANDBOXING = 5;
    UNSANDBOXING = 6;
    EXECUTING = 7;
    ARCHIVED = 8;
}

message Transaction {
  Status status = 1;
  string transactionId = 2;
  string message = 3;
}

// NOTE: replaces RequestVmCreate and RequestVmCommands from previous versions. TODO should be called VmId
message VmId {
  Transaction transaction = 1;
  string vmId = 2;
}

// TODO : Who determines the vmUserName and vmUserPassword? I would say the Host, so these should be part of the response
message VmCreate {
  Transaction transaction = 1;
  string vmId = 2;
  string userId = 3;  // TODO userName? Identical to vmId?
  string ovaFile = 4;
  string bulkCommandId = 5;
}

message VmDetails {
  Transaction transaction = 1;
  string vmId = 2;
  string userId = 3;  // TODO Identical to vmId?
  string userName = 4;
  string initialUserPw = 5;  // TODO see this as initial password. Hosts may refuse to include this here.
  string ip = 6;
  string sshPort = 7;
  string rdpPort = 8;
  // string adminName = 9; // TODO I've taken them out. The idea here is that only the host knows the admin pass and uses this to execute the software.
  // string adminPw = 10;
}

message RunId {
  Transaction transaction = 1;
  string vmId = 2;
  string datasetId = 3;
  string runId = 4;
}

// TODO again, when telling the host to execute a software, it needs to know how to connect to it, hence we only need to submit the software details.
message RunDetails {
  Transaction transaction = 1;
  RunId runId = 2;
  string workingDir = 3;
  string command = 4;
  RunId inputRunId = 5;
  string optionalParameters = 6;
  // string outputDirName = 7;  // Host must determine this
  // string sandboxed = 8;  // Note sure how this makes sense
  // string snapshotName = 9; // Note sure if this still makes sense
}

message EvaluationResults {
  message Measure {
    string key   = 1;
    string value = 2;
  }
  Transaction transaction = 1;
  RunId runId = 2;
  repeated Measure measures = 3;
}

message VmState {
  Transaction transaction = 1;
  Status status = 2;
  State state = 3;
  string vmId = 4;
  string message = 5;
}

message VmInfo {
  Transaction transaction = 1;
  Status status = 2;
  string guestOs = 3;
  string memorySize = 4;
  string numberOfCpus = 5;
  string sshPort = 6;
  string rdpPort = 7;
  string host = 8;
  bool sshPortStatus = 9;
  bool rdpPortStatus = 10;
  State state = 11;
}

message CommandState {
  string hostname = 1;

  message Command {
    string id = 1;
    string commandString = 2;
    string startTime = 3;
    string endTime = 4;
    enum Status {
      RUNNING = 0;
      SUCCESS = 1;
      FAILED = 2;
    }
    Status status = 5;
    string logFile = 6;
    int32 returnCode = 7;
    string bulkCommandId = 8;
  }

  repeated Command commands = 2;
}

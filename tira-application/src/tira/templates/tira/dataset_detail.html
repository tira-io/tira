{% extends 'tira/base.html' %}
{% load static %}
{% block title %}TIRA Users{% endblock %}
{% block description %}TIRA Users{% endblock %}
{% block navbar %}{% include "tira/navbar.html" with nav_active='tasks' %}{% endblock %}

{% block content %}
<nav class="uk-container">
    <ul class="uk-breadcrumb">
        <li><a href="{% url 'tira:index' %}">Tira.io</a></li>
        <li><a href="{% url 'tira:task-detail' task_id=task.task_id %}">{{ task.task_name }}</a></li>
        <li class="uk-disabled"><a href="#">{{ dataset_id }}</a></li>
    </ul>
</nav>

<main class="uk-section uk-section-default">
    <div class="uk-container">
        <div uk-grid>
            <div class="uk-width-expand">
                <h1>{{ task.task_name }} <span class="uk-text-muted">Leaderboard</span></h1>
            </div>
            <div>
                <a class="uk-button uk-button-default uk-text-large"
                   uk-tooltip="title: Task Website;"
                   href="{{ task.web }}">
                   <span class="uk-padding-small">Task Website</span><i class="fas fa-external-link-alt uk-margin-small-left"></i></a>
                <a class="uk-button uk-button-primary uk-text-large"
                   uk-tooltip="title: Participate;"
                   href="{% if role == 'guest' %}{% url 'tira:login' %}{% else %}{% url 'tira:software-detail' task_id=task.task_id vm_id=vm_id %}{% endif %}">
                   <i class="fas fa-terminal uk-margin-right"></i>Submit</a>
            </div>
        </div>
    </div>

    <div class="uk-container uk-margin-medium">
        <h2>Dataset: <span class="uk-text-muted">{{ dataset_id }}</span></h2>
        <table class="uk-margin-small uk-table uk-table-divider uk-table-small sortable targetable">
            <thead>
            <tr>
                <th id="tira-evaluation-results"></th>
                {% if role == 'admin' %}
                <th colspan="{{ ev_keys|length|add:'5' }}">
                    {% else %}
                <th colspan="{{ ev_keys|length|add:'5' }}">
                    {% endif %}
                    Results of {{ dataset_id }}
                    <a href="#" class="uk-float-right uk-link-reset" data-uk-icon="chevron-up"></a>
                </th>
            </tr>
            <tr>
                <th></th>
                {% if role == 'admin' %}
                <th class="header uk-table-shrink">&nbsp;</th>
                <th class="header uk-table-shrink">&nbsp;</th>
                {% endif %}
                <th class="header uk-table-shrink uk-text-nowrap"><span>Virtual Machine</span></th>
                <th class="header uk-table-shrink uk-text-nowrap"><span>Run</span></th>
                {% for key in ev_keys %}
                <th class="header uk-table-shrink uk-text-nowrap"><span>{{ key }}</span></th>
                {% endfor %}
                {% if role == 'admin' %}
                <th class="header uk-table-shrink uk-text-nowrap"><span>Actions</span></th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for eval in evaluations %}
            <tr>
                <td id="{{ dataset_id }}-{{ eval.vm_id }}-{{ eval.run_id }}"></td>
                {% if role == 'admin' %}
                <td class="uk-table-shrink">
                    {% if eval.blinded == True %}
                    <div uk-tooltip="This run is blinded">
                        <i class="fas fa-user-slash dataset-detail-icon"></i>
                    </div>
                    {% else %}
                    <div uk-tooltip="This run is visible to the participant">
                        <i class="fas fa-user dataset-detail-icon uk-text-success"></i>
                    </div>
                    {% endif %}
                </td>
                <td class="uk-table-shrink"> <!-- Icons -->
                    {% if eval.published == True %}
                    <div uk-tooltip="This run is on the leaderbords">
                        <i class="fas fa-users dataset-detail-icon uk-text-success"></i>
                    </div>
                    {% else %}
                    <div uk-tooltip="This run is not published">
                        <i class="fas fa-users-slash dataset-detail-icon"></i>
                    </div>
                    {% endif %}
                </td> <!-- id? -->
                {% endif %}
                <td class="uk-table-shrink uk-text-nowrap">{{ eval.vm_id }}</td>
                {% if role == 'admin' %}
                <td class="uk-table-shrink uk-text-nowrap"><a href="#run-{{ eval.vm_id }}-{{ eval.run_id }}">{{ eval.run_id }}</a></td>
                {% else %}
                <td class="uk-table-shrink uk-text-nowrap">{{ eval.run_id }}</td>
                {% endif %}
                {% for measure in eval.measures %}
                <td class="uk-table-shrink uk-text-truncate">{{ measure }}</td>
                {% endfor %}
                {% if role == 'admin' %}
                <td class="uk-table-shrink uk-text-nowrap"><a class="uk-button uk-button-small uk-button-default" href="{% url 'tira:software-detail' task_id=task.task_id vm_id=eval.vm_id %}">manage</a></td>
                {% endif %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Run results - TODO only show when user is reviewer  -->
    {% if role == 'admin' %}
    <div class="uk-container uk-margin-medium">
        <h2 id="tira-runs">Runs</h2>
        <ul id="tira-run-accordion" class="uk-list uk-list-collapse uk-list-striped" uk-accordion="multiple: true">
            {% for vm in vms %}
            <li>
                <div class="uk-accordion-title uk-grid-collapse" data-uk-grid>
                    <div>
                        <table class="uk-text-small uk-width-5-6">
                            <tr>
                                <td class="uk-width-1-5 uk-text-left"><b>{{ vm.vm_id }}</b></td>
                                <td class="uk-width-1-5 uk-text-right">{{ vm.runs|length }} Runs</td>
                                <td class="uk-width-1-5 uk-text-right {% if vm.unreviewed_count > 0 %}uk-text-warning{% endif %}">
                                    {{ vm.unreviewed_count }} Unreviewed</td>
                                <td class="uk-width-1-5 uk-text-right">{{ vm.blinded_count }} Blinded</td>
                                <td class="uk-width-1-5 uk-text-right {% if vm.published_count == 0 %}uk-text-warning{% endif %}">
                                    {{ vm.published_count }} Published</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="uk-accordion-content uk-margin-remove-top">
                    <a href="{% url 'tira:software-detail' task_id=task.task_id vm_id=vm.vm_id %}">
                        [manage user]
                    </a>
                    <table class="uk-margin-medium uk-margin-remove-top uk-table uk-table-divider uk-table-small sortable">
                        <thead>
                        <tr>
                            <th class="uk-table-shrink"></th>
                            <th class="uk-table-shrink"></th>
                            <th class="uk-table-shrink"></th>
                            <th class="uk-table-shrink"></th>
                            <th class="header uk-table-shrink uk-text-nowrap"><span>Software</span></th>
                            <th class="header uk-table-shrink uk-text-nowrap"><span>Run</span></th>
                            <th class="header uk-table-shrink uk-text-nowrap"><span>Input Run</span></th>
                            <th class="header uk-table-shrink uk-text-nowrap">Reviewer</th>
                            <th class="header uk-table-shrink uk-text-nowrap">Review</th>
                            <th class="header uk-table-shrink uk-text-nowrap"><span>Actions</span></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for run in vm.runs %}
                        <tr>
                            <td class="uk-table-shrink" id="run-{{ vm.vm_id }}-{{ run.run.run_id }}"></td>
                            <td class="uk-table-shrink">
                                {% if run.review.noErrors == True %}
                                <div uk-tooltip="This run is OK">
                                    <i class="fas fa-check dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% elif run.review.hasErrors == True %}
                                <div uk-tooltip="This run has errors">
                                    <i class="fas fa-times dataset-detail-icon uk-text-danger"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink">
                                {% if run.review.blinded == True %}
                                <div uk-tooltip="This run is blinded">
                                    <i class="fas fa-user-slash dataset-detail-icon"></i>
                                </div>
                                {% else %}
                                <div uk-tooltip="This run is visible to the participant">
                                    <i class="fas fa-user dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink"> <!-- Icons -->
                                {% if run.review.published == True %}
                                <div uk-tooltip="This run is on the leaderboards">
                                    <i class="fas fa-users dataset-detail-icon uk-text-success"></i>
                                </div>
                                {% else %}
                                <div uk-tooltip="This run is not published">
                                    <i class="fas fa-users-slash dataset-detail-icon"></i>
                                </div>
                                {% endif %}
                            </td>
{% comment %}                            <td class="uk-table-shrink">{% endcomment %}
{% comment %}                                <div uk-tooltip="Download Run">{% endcomment %}
{% comment %}                                </div>{% endcomment %}
{% comment %}                            </td>{% endcomment %}
                            <td class="uk-table-shrink uk-text-nowrap">{{ run.run.software }}</td>
                            <td class="uk-table-shrink uk-text-nowrap">{{ run.run.run_id }}</td>
                            {% if run.run.input_run_id != 'none' %}
                            <td class="uk-table-shrink uk-text-nowrap"><a href="#run-{{ vm.vm_id }}-{{ run.run.input_run_id }}">{{ run.run.input_run_id }}</a>
                            </td>
                            {% else %}
                            <td class="uk-table-shrink uk-text-nowrap">{{ run.run.input_run_id }}</td>
                            {% endif %}
                            <td class="uk-table-shrink uk-text-nowrap">{{ run.review.reviewer }}</td>
                            <td class="uk-table-expand uk-text-truncate">
                                {% if run.review.noErrors == True %}

                                {% elif run.review.hasErrorOutput == True %}
                                Output Error
                                {% elif run.review.otherErrors == True %}
                                Software Error
                                {% endif %}
                                {% if run.review.comment != "" %}
                                : {{ run.review.comment }}
                                {% endif %}
                            </td>
                            <td class="uk-table-shrink uk-text-nowrap">
                                <a class="uk-button uk-button-small uk-button-default" href="{% url 'tira:review' task_id=task.task_id vm_id=vm.vm_id dataset_id=dataset_id run_id=run.run.run_id %}">review</a>
                                <a class="uk-button uk-button-small uk-button-default" href="{% url 'tira:download_rundir' task_id=task.task_id vm_id=vm.vm_id dataset_id=dataset_id run_id=run.run.run_id %}" target="_blank">download run</a>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

</main>

{% if not include_navigation %}
<script src="https://assets.webis.de/js/thirdparty/jquery/jquery.slim.min.js"></script>
{% endif %}
<script src="https://assets.webis.de/js/thirdparty/fontawesome/fontawesome.min.js"></script>
<script src="https://assets.webis.de/js/thirdparty/fontawesome/solid.min.js"></script>
<script src="https://assets.webis.de/js/filter.js"></script>
<script src="https://assets.webis.de/js/selection.js"></script>
<script src="https://assets.webis.de/js/tables.js"></script>
<script>initWebisTableFiltering();</script>
<script>initTableSorting();</script>

{% endblock %}
